#!/bin/sh

# Determine whether to recommend/use the HEAD revision of FFmpeg (unreleased)
# or a specific revision based upon whether the last digit of our version
# is even or odd. An odd MLT version number always represents unreleased.
svn_rev="19873"
micro_version=$(echo $version | cut -d . -f 3)
odd_version=$(($micro_version % 2))
[ "$odd_version" -eq "1" ] && svn_rev="HEAD"

if [ "$help" = "1" ]
then
	cat << EOF
FFmpeg/avformat options:

  --avformat-svn          - Obtain FFmpeg from its Subversion repository
  --avformat-svn-version  - Specify a particular revision for --avformat-svn
  --avformat-svn-extra    - Add extra configure options for --avformat-svn
  --avformat-shared=path  - Link against a shared installation of FFmpeg (default)
  --avformat-static=path  - Link against a static FFmpeg development tree
  --avformat-ldextra=libs - Provide additional libs to link with
  --avformat-suffix=suff  - Specify a custom suffix for a shared build of FFmpeg
  --avformat-swscale      - Use libswcale instead of img_convert
  --avformat-no-codecs    - Disable the producer and consumer to avoid the FFmpeg codecs
  --avformat-no-filters   - Disable the filters to make a codecs+muxers-only plugin

  NOTE: The recommended version of FFmpeg is $([ "$svn_rev" = "0.5" ] && echo $svn_rev || echo SVN-r$svn_rev).

EOF

else
	targetos=$(uname -s)
	case $targetos in
	Darwin)
		export LIBSUF=.dylib
		;;
	Linux|FreeBSD)
		export LIBSUF=.so
		;;
	*)
		;;
	esac
		
	bits=$(uname -m)
	case $bits in
	x86_64)
		[ -d /usr/lib/lib64 ] && export LIBDIR=lib64 || export LIBDIR=lib
		;;
	*)
		export LIBDIR=lib
		;;
	esac

	echo > config.mak

	export static_ffmpeg=
	export shared_ffmpeg=$(pkg-config --variable=prefix libavformat)
	export extra_libs=
	export svn_ffmpeg=
	export svn_ffmpeg_extra=
	export avformat_suffix=
	export swscale=
	export codecs=true
	export filters=true
	export vdpau=

	for i in "$@"
	do
		case $i in
			--avformat-static=* )	static_ffmpeg="${i#--avformat-static=}" ;;
			--avformat-shared=* )	shared_ffmpeg="${i#--avformat-shared=}" ;;
			--avformat-ldextra=* )	extra_libs="${i#--avformat-ldextra=}" ;;
			--avformat-svn )		svn_ffmpeg=true ;;
			--avformat-svn-extra=* ) svn_ffmpeg_extra="${i#--avformat-svn-extra=}" ;;
			--avformat-svn-version=* )	svn_rev="${i#--avformat-svn-version=}" ;;
			--avformat-cvs )		svn_ffmpeg=true ;;
			--avformat-suffix=* )	avformat_suffix="${i#--avformat-suffix=}" ;;
			--avformat-swscale )	swscale=true ;;
			--avformat-swscaler )	swscale=true ;;
			--avformat-no-codecs )	codecs=false ;;
			--avformat-no-filters )	filters=false ;;
		esac
	done

	if [ "$svn_ffmpeg" != "" ]
	then
		if [ "$gpl" = "true" ]
		then
			enable_gpl="--enable-gpl"
			[ "$swscale" != "" ] && [ "$svn_rev" = "0.5" ] &&
				enable_swscale="--enable-swscale"
		fi
		if [ ! -d "ffmpeg" ]
		then
			echo
			echo "Checking out ffmpeg/avformat revision $svn_rev - no password required"
			echo
			if [ "$svn_rev" = "0.5" ]; then
				svn checkout svn://svn.mplayerhq.hu/ffmpeg/branches/$svn_rev ffmpeg
			else
				svn checkout -r $svn_rev svn://svn.mplayerhq.hu/ffmpeg/trunk ffmpeg
			fi
		fi
		[ -d "ffmpeg" ] && ( cd ffmpeg ; ./configure $enable_gpl $enable_swscale $svn_ffmpeg_extra )
		#[ ! -f "ffmpeg/ffmpeg.patch" ] && ( cd ffmpeg ; cp ../ffmpeg.patch . ; patch -p0 < ffmpeg.patch )
		echo "CFLAGS+=-I`pwd`/ffmpeg -I`pwd`/ffmpeg/libavformat -I`pwd`/ffmpeg/libavcodec -I`pwd`/ffmpeg/libavutil -I`pwd`/ffmpeg/libavdevice" >> config.mak
		echo "LDFLAGS+=-L`pwd`/ffmpeg/libavformat -L`pwd`/ffmpeg/libavcodec -L`pwd`/ffmpeg/libavutil -L`pwd`/ffmpeg/libavdevice" >> config.mak
		if [ "$swscale" != "" ] || [ "$svn_rev" = "HEAD" ]
		then
			echo "CFLAGS+=-I`pwd`/ffmpeg/libswscale" >> config.mak
			echo "LDFLAGS+=-L`pwd`/ffmpeg/libswscale" >> config.mak
			echo "SWSCALE=1" >> config.mak
		fi
		[ $targetos = "Darwin" ] &&
			echo "LDFLAGS+=-single_module" >> config.mak
		echo "LOCAL_FFMPEG=1" >> config.mak
		echo "LDFLAGS+=-Wl,-Bsymbolic" >> config.mak
		extra_libs="$extra_libs -lm -lz -lbz2"
		echo -e "#include <libavcodec/vdpau.h>\n int main(){ VdpBitstreamBuffer test; test.struct_version; return 0;}" | gcc -I"`pwd`/ffmpeg" $CFLAGS -c -x c -  >/dev/null 2>&1
		[ "$?" = "0" ] && echo "VDPAU=1" >> config.mak
	elif [ "$static_ffmpeg" != "" ]
	then 
		if [ -d "$static_ffmpeg" ]
		then
			echo "CFLAGS+=-I$static_ffmpeg/libavformat -I$static_ffmpeg/libavcodec -I$static_ffmpeg/libavutil -I$static_ffmpeg/libavdevice" >> config.mak
			echo "LDFLAGS+=-L$static_ffmpeg/libavformat -L$static_ffmpeg/libavcodec -L$static_ffmpeg/libavutil -L$static_ffmpeg/libavdevice" >> config.mak
			[ $targetos = "Darwin" ] &&
			 	echo "LDFLAGS+=-single_module" >> config.mak
			if [ "$swscale" != "" ]
			then
				echo "CFLAGS+=-I$static_ffmpeg/libswscale" >> config.mak
				echo "LDFLAGS+=-L$static_ffmpeg/libswscale" >> config.mak
				echo "SWSCALE=1" >> config.mak
			fi
			echo "LDFLAGS+=-Wl,-Bsymbolic" >> config.mak
			extra_libs="$extra_libs -lm -lz -lbz2"
			echo -e "#include <libavcodec/vdpau.h>\n int main(){ VdpBitstreamBuffer test; test.struct_version; return 0;}" | gcc -I"$static_ffmpeg" $CFLAGS -c -x c -  >/dev/null 2>&1
			[ "$?" = "0" ] && echo "VDPAU=1" >> config.mak
		else
			echo "avformat: Invalid path specified: $static_ffmpeg"
			touch ../disable-avformat
			echo 0
		fi
	elif [ "$shared_ffmpeg" != "" ]
	then
		echo "PREFIX=$shared_ffmpeg" >> config.mak
		echo "CFLAGS+=$(pkg-config --cflags libavformat) $TMP_CFLAGS" >> config.mak
		echo "LDFLAGS+=$(pkg-config --libs libavformat)" >> config.mak
		[ -d "$shared_ffmpeg/include/ffmpeg/libavformat" ] &&
			echo "CFLAGS+=-I$shared_ffmpeg/include/ffmpeg/libavformat -I$shared_ffmpeg/include/ffmpeg/libavcodec" >> config.mak
		[ -d "$shared_ffmpeg/include/libavformat" ] &&
			echo "CFLAGS+=-I$shared_ffmpeg/include/libavformat -I$shared_ffmpeg/include/libavcodec" >> config.mak
		avcodec_version=$(pkg-config --modversion libavcodec)
		if [ "$swscale" != "" ] || ( [ $(echo $avcodec_version | cut -d. -f1) -ge 52 ] && [ $(echo $avcodec_version | cut -d. -f2) -ge 21 ] )
		then
			[ -d "$shared_ffmpeg/include/ffmpeg/libswscale" ] &&
				echo "CFLAGS+=-I$shared_ffmpeg/include/ffmpeg/libswscale" >> config.mak
			[ -d "$shared_ffmpeg/include/libswscale" ] &&
				echo "CFLAGS+=-I$shared_ffmpeg/include/libswscale" >> config.mak
			echo "SWSCALE=1" >> config.mak
		fi
		echo -e "#include <libavcodec/vdpau.h>\n int main(){ VdpBitstreamBuffer test; test.struct_version; return 0;}" | gcc -I"$(pkg-config --cflags libavformat)" -I"$shared_ffmpeg/include" $CFLAGS -c -x c -  >/dev/null 2>&1
		[ "$?" = "0" ] && echo "VDPAU=1" >> config.mak
	else
		echo "avformat: No build environment found. "
		echo "          Try configuring mlt with --avformat-svn."
		touch ../disable-avformat
		exit 0
	fi

	echo "EXTRA_LIBS=$extra_libs" >> config.mak
	echo "AVFORMAT_SUFFIX=$avformat_suffix" >> config.mak
	[ "$codecs" = "true" ] && echo "CODECS=1" >> config.mak
	[ "$filters" = "true" ] && echo "FILTERS=1" >> config.mak
	exit 0

fi
